# CircleCI configuration file for building Evolution X ROM
version: 2.1

# Define the build job
jobs:
  build-rom:
    docker:
      - image: cimg/base:current
    resource_class: large
    steps:
      - checkout
      - run:
          name: "Set up Git configuration"
          command: |
            git config --global user.email "diamondguys256x@gmail.com"
            git config --global user.name "NoNameBuilder"
      - run:
          name: "Install required tools"
          command: |
            sudo apt-get update && sudo apt-get install -y \
              python3 curl unzip git repo ccache openjdk-11-jdk
      - run:
          name: "Initialize repo"
          command: |
            repo init -u https://github.com/Evolution-X/manifest -b vic
      - run:
          name: "Sync repo"
          command: |
            repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
      - run:
          name: "Pull additional repositories"
          command: |
            git clone --depth=1 --progress --verbose https://git.mainlining.org/zircon-development/proprietary_vendor_xiaomi_zircon vendor/xiaomi/zircon
            git clone --depth=1 --progress --verbose https://github.com/zircon-development/android_device_xiaomi_zircon-miuicamera device/xiaomi/zircon-miuicamera
            git clone --depth=1 --progress --verbose https://github.com/zircon-development/android_kernel_xiaomi_mt6886 kernel/xiaomi/mt6886
            git clone --depth=1 --progress --verbose https://github.com/zircon-development/android_device_mediatek_sepolicy_vndr device/mediatek/sepolicy_vndr
      - run:
          name: "Link device tree"
          command: |
            mkdir -p device/xiaomi/zircon
            ln -s $(pwd)/vendor/xiaomi/zircon device/xiaomi/zircon
      - run:
          name: "Source build environment and set up device"
          command: |
            source build/envsetup.sh
            breakfast lineageos_zircon_ap3a-userdebug
      - run:
          name: "Set up ccache"
          command: |
            export USE_CCACHE=1
            export CCACHE_DIR=~/.ccache
            export CCACHE_EXEC=/usr/bin/ccache
            ccache -M 50G
      - run:
          name: "Start ROM build"
          command: |
            m evolution

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build-rom
